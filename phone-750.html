<!DOCTYPE html>
<html>
<head>
	<meta charset='utf-8' />
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
	<title></title>
	<style type="text/css">
		*{padding: 0;margin: 0;}
		.wrapper{
    		margin: 50px auto;
    		padding: 0 10px;
		}
		#drop_area {
		    width: 100%;
		    height: 80px;
		    border: 3px dashed silver;
		    line-height: 80px;
		    text-align: center;
		    font-size: 36px;
		    color: #d3d3d3;
		    opacity: 0;
		    position: relative;
		    z-index: 8
		}
		#img{
			width: auto;
			height: auto;
			position: absolute;
			visibility: hidden;
		}
		.canvas-wrapper{
			text-align: center;
			margin-bottom: 50px;
		}
		#myCanvas2{
			
		}
		input[type='range']{
			width: 100%;
			height: 30px;
		}
		.file-wrapper{
			width: 100%;
			height: 80px;
			position: relative;
		}
		.file-wrapper span{
			font-size: 40px;
			line-height: 80px;
			text-align: center;
			position: absolute;
			width: 100%;
			height: 80px;
			top: 0;
			left: 0;
		}

	</style>
	<script type="text/javascript" src="http://cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
	<script type="text/javascript">
		$(function(){
			var rangeAvgVal,rangeNumVal;
			var left = 200;
			var top = 635;
			var width = 750;
			//阻止浏览器默认行。 
		    $(document).on({ 
		        dragleave:function(e){    //拖离 
		            e.preventDefault(); 
		        }, 
		        drop:function(e){  //拖后放 
		            e.preventDefault(); 
		        }, 
		        dragenter:function(e){    //拖进 
		            e.preventDefault(); 
		        }, 
		        dragover:function(e){    //拖来拖去 
		            e.preventDefault(); 
		        }
		    }); 
		    var box = document.getElementById('drop_area'); //拖拽区域 
		    box.addEventListener("change",function(e){
		        e.preventDefault(); //取消默认浏览器拖拽效果 
		        var fileList = this.files;
		        readFile(fileList[0]);
		        
		    },false);
		    function readFile(file){
				if(window.FileReader) {
	                var fr = new FileReader();
	                fr.onloadend = function(event) {
	                    var data = event.target.result;
	                    img2canvas(data)
	                };
	                fr.readAsDataURL(file);
	            }else{
	            	alert('浏览器不支持FileReader,换chrome吧');
	            }
		    }
		    function img2canvas(data){
		    	var myImage = $('#img')[0];
                $(myImage).attr('src',data);
                var canvas = document.getElementById('myCanvas');
				
				canvas.width = width-left*2//myImage.width;
				canvas.height = width-left*2//myImage.height;
				var ctx = canvas.getContext('2d');
				//console.log(w,h)
				ctx.drawImage(myImage,left,top,width-left*2,width-left*2,0,0,width-left*2,width-left*2);
				$('#rangeAvg').off('input').on('input',function(){
					rangeAvgVal = $(this).val();
					$('#rangeAvgVal').html(rangeAvgVal);
					findColor();
				}).trigger('input');
				$('#rangeNum').off('input').on('input',function(){
					rangeNumVal = $(this).val();
					$('#rangeNumVal').html(rangeNumVal);
					findColor();
				}).trigger('input');
			}
		    function findColor(){
		    	var myImage = $('#img')[0];
				var canvas = document.getElementById('myCanvas');
				

		    	
			    var ctx = canvas.getContext('2d');
	            var imagedata = ctx.getImageData( 0 , 0 , canvas.width , canvas.height ) ;
	            var arr = [];
	            for ( var i = 0 , h = canvas.height ; i < h ; i ++ ) {
	            	var row = 0;
	            	for ( var j = 0 , w = canvas.width ; j < w ; j ++ ) {
	            		var k = i * w * 4 + j * 4;
	            		row += Math.floor((imagedata.data[ k ] + imagedata.data[ k + 1 ] + imagedata.data[ k + 2 ])/3);
	            		
	            	}
					
	            	if( row / canvas.width < rangeAvgVal ){
	            		arr.push(i);
	            	}else{
	            		if( arr.length >= rangeNumVal ){
	            			arr.unshift(arr[0]-1);
	            			arr.push(i);
	            			arr.push(i+1);
	            			replaceColor(imagedata,arr);
	            		}
	            		arr = [];
	            	}
	            }
	            canvas = document.getElementById('myCanvas2');
	            canvas.width = width-left*2//myImage.width;
				canvas.height = width-left*2//myImage.height;
	            ctx = canvas.getContext('2d');
			    ctx.putImageData( imagedata , 0 , 0 ) ; 
		    }
		    function replaceColor(imagedata,arr){
		    	var myImage = $('#img')[0];
		    	var currentIndex = arr[0];
	            var preIndex = currentIndex - 2;
	            var nextIndex = arr[arr.length-1] + 2;
		    	for ( var i = currentIndex; i < arr[arr.length-1] ; i ++ ) {
	            	for ( var j = 0 , w = width-left*2 ; j < w ; j ++ ) {
	            		var k = i * w * 4 + j * 4;
	            		var preK = preIndex * w * 4 + j * 4;
	            		var nextK = nextIndex * w * 4 + j * 4;
	            		var avgR = Math.floor((imagedata.data[ preK ] + imagedata.data[ nextK ])/2);
	            		var avgG = Math.floor((imagedata.data[ preK + 1 ] + imagedata.data[ nextK + 1 ])/2);
	            		var avgB = Math.floor((imagedata.data[ preK +2 ] + imagedata.data[ nextK +2 ])/2);
	            		//console.log(imagedata.data[ preK ] , imagedata.data[ preK+1 ], imagedata.data[ preK+2 ],imagedata.data[ k ] , imagedata.data[ k+1 ], imagedata.data[ k+2 ]);
	            		imagedata.data[ k ] = avgR;
	            		imagedata.data[ k + 1 ] = avgG;
	            		imagedata.data[ k + 2 ] = avgB;
	            	}
	            	
	            }
		    }
		    
		    
		});
	</script>
</head>
<body>
<div class="wrapper">
	<div>范围40~80，默认65,当前<span id="rangeAvgVal"></span></div>
	<div><input type="range" id="rangeAvg" min="40" max="80" step="1" value="65" autocomplete="off"></div>

	<div>范围1~4，默认3，当前<span id="rangeNumVal"></span></div>
	<div><input type="range" id="rangeNum" min="1" max="4" step="1" value="3" autocomplete="off">
	</div>
	<div class="file-wrapper">
		<input type="file" id="drop_area" accept="image/*" />
		<span>点击上传图片</span>
	</div>
	
	<div>
		<img src="" id="img">
	</div>
	<div class="canvas-wrapper">
		<canvas id="myCanvas2" width="300" height="300" >
	Your browser does not support the HTML5 canvas tag.
	</canvas>
	</div>
	
	<div class="canvas-wrapper">
		<canvas id="myCanvas" width="300" height="300" >
	Your browser does not support the HTML5 canvas tag.
	</canvas>
	</div>
	
</div>

</body>
</html>